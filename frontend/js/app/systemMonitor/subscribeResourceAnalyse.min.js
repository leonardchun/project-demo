define(["base","app/commonApp","echarts","date"],function(e,a,t){var r=["#04a0fa","#fa7e04"];var i=["#fa4f04","#5edb02","#02d2b2","#6b03e1"];var n=null;var s={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,pagingType:"full_numbers",ajax:{url:$.path+"/api/subscribeanalysis/findSubscribeResAnalysePage",type:"get",contentType:"application/json",data:function(t){a.gridPageFliter(t);var r=e.form.getParams($("#search-form"));if(!r.equipment)r.equipment="0";if(!r.resourceId)r.resourceId="0";var i;if(r){i=$.extend({resType:"1",page:t.page,size:t.size},r)}return i}},columns:[{data:"startTime",sWidth:"25%"},{data:"loadFlowTotal",sWidth:"25%"},{data:"loadRecordTotal",sWidth:"25%"},{data:"taskTotal",sWidth:"25%"}],drawCallback:function(e){}};var o={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,pagingType:"full_numbers",ajax:{url:$.path+"/api/subscribeanalysis/findSubscribeResAnalysePage",type:"get",contentType:"application/json",data:function(t){a.gridPageFliter(t);var r=e.form.getParams($("#search-form"));if(!r.equipment)r.equipment="0";if(!r.resourceId)r.resourceId="0";var i;if(r){i=$.extend({resType:"2",page:t.page,size:t.size},r)}return i}},columns:[{data:"startTime",sWidth:"25%"},{data:"loadFlowTotal",sWidth:"25%"},{data:"loadRecordTotal",sWidth:"25%"},{data:"taskTotal",sWidth:"25%"}],drawCallback:function(e){}};var l={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,pagingType:"full_numbers",ajax:{url:$.path+"/api/subscribeanalysis/findSubscribeResAnalysePage",type:"get",contentType:"application/json",data:function(t){a.gridPageFliter(t);var r=e.form.getParams($("#search-form"));if(!r.equipment)r.equipment="0";if(!r.resourceId)r.resourceId="0";var i;if(r){i=$.extend({resType:"3",page:t.page,size:t.size},r)}return i}},columns:[{data:"startTime",sWidth:"33.3%"},{data:"subApiTotal",sWidth:"33.3%"},{data:"loadRecordTotal",sWidth:"33.3%"}],drawCallback:function(e){}};var d=function(t){if(!t||t=="1"){n=e.datatables({container:$("#example1"),option:s,filter:a.gridFilter})}else if(t=="2"){n=e.datatables({container:$("#example2"),option:o,filter:a.gridFilter})}else if(t=="3"){n=e.datatables({container:$("#example3"),option:l,filter:a.gridFilter})}};var u={color:r,legend:{left:"center",data:[]},tooltip:{trigger:"axis",axisPointer:{animation:false}},grid:{top:"20%",left:"5%",right:"5%",bottom:"10%",containLabel:true},xAxis:{type:"category",data:[],boundaryGap:true},yAxis:{type:"value",boundaryGap:[0,0],splitLine:{show:true,lineStyle:{color:"#c0c0c0"}}},series:[{name:"流入",type:"line",hoverAnimation:false,smooth:true,areaStyle:{normal:{color:"#20a8d8",opacity:"0.2"}},data:[]}]};var c={color:["#2fb6e6","#faba3c","#67c2ef","#ff8e8e","#00acee"],tooltip:{trigger:"item",formatter:function(e){if(e.data.names.length>25){var a=[];for(var t=0;t<e.data.names.length;t++){if(t>=25&&t%25==0){a.push(e.data.names[t]+"<br />")}else{a.push(e.data.names[t])}}var r=a.join("");return e.seriesName+"<br />"+r+" ("+e.percent+"%)"}else{return e.seriesName+"<br />"+e.data.names+" ("+e.percent+"%)"}}},legend:{orient:"vertical",top:"middle",right:"18%",itemWidth:15,itemHeight:15,data:[]},series:[{name:"订阅设备",type:"pie",radius:["50%","70%"],avoidLabelOverlap:false,hoverAnimation:false,label:{normal:{show:true,position:"center",formatter:function(e,a,t,r){return e.seriesName}}},labelLine:{normal:{show:false}},center:["30%","50%"],data:[]}]};var p=function(a,r,i){var n={};n.chart=null;var s=e.form.getParams($("#search-form"));if(!s.equipment)s.equipment="0";if(!s.resourceId)s.resourceId="0";var o=$.extend({lineChartType:i?i:"1",resType:a?a:"1"},s);n.draw=function(a){e.ajax({url:$.path+"/api/subscribeanalysis/findLineChartDeta",type:"post",params:o,success:function(a){var a=a.data;if(JSON.stringify(a)=="{}"){a=[{xvalue:"",yvalue:""}]}var i=[],s=[];a.forEach(function(e,a){i.push(e.xvalue);s.push(e.yvalue)});if(i.length==1){u.series[0].symbolSize=10}else{u.series[0].symbolSize=0}u.yAxis.min=0;u.yAxis.minInterval=1;u.yAxis.axisLabel={textStyle:{color:"#666"},formatter:function(e,a){return parseInt(e)}};u.xAxis.data=i;u.series[0].data=s;u.series[0].name=r?r:"加载流量";n.chart=e.echarts({container:$("#chart1"),echarts:t,chartOption:u})}})};n.draw(true)};var f=function(a,r){var i={};i.chart=null;var n=e.form.getParams($("#search-form"));i.params={startTime:n.endTime,resType:a?a:"1"};i.draw=function(a){e.ajax({url:$.path+"/api/subscribeanalysis/findSubLoadFlowTop",type:"post",params:i.params,success:function(a){var a=a.data;if(JSON.stringify(a)=="{}"){a={"暂无订阅设备":0}}var r=[],n=[];for(var s in a){if(s&&s.indexOf("暂无")>-1){r.push(s);n.push({itemStyle:{normal:{color:"#d8d8d8"}},value:parseFloat(a[s]),name:s,names:s});c.color=["#d8d8d8"]}else{var o=s.slice(0,10);r.push(o);n.push({value:parseFloat(a[s]),name:o,names:s})}}c.legend.data=r;c.series[0].data=n;i.chart=e.echarts({container:$("#chart2"),chartOption:c,echarts:t})}})};i.draw()};var m=function(){e.form.date({element:$("#startTime"),dateOption:{max:laydate.now(-1,"YYYY-MM-DD")}});e.form.date({element:$("#endTime"),dateOption:{max:laydate.now()}});$("#startTime").val(laydate.now(-31,"YYYY-MM-DD"));$("#endTime").val(laydate.now(-1,"YYYY-MM-DD"))};var v=function(a){var t={resType:a?a:"1",equipment:"0"};e.ajax({type:"post",url:$.path+"/api/subscribeanalysis/findSubResName",params:t,success:function(a){e.template({container:$(".sourceName"),templateId:"sourceName-tpl",data:a.data})}})};var h=function(e,a){var t=[{key:"loadRecordTotal",label:"加载记录数",type:"0",value:"1"},{key:"loadFlowTotal",label:"加载流量",type:"0",value:"2"},{key:"taskTotal",label:"任务执行次数",type:"0",value:"3"},{key:"subApiTotal",label:"订阅API数",type:"0",value:"4"},{key:"appNum",label:"订阅应用数",type:"0",value:""}];if(e=="loadRecordTotal"){if(a=="1")return{name:"加载记录数",value:"1"};if(a=="2")return{name:"加载文件数",value:"1"};if(a=="3")return{name:"调用次数",value:"1"}}for(var r=0;r<t.length;r++){if(t[r].key==e){return{name:t[r].label,value:t[r].value}}}};var g=function(a){var a=a?a:"1";var t=e.form.getParams($("#search-form"));if(!t.equipment)t.equipment="0";if(!t.resourceId)t.resourceId="0";var r=$.extend({resType:a},t);e.ajax({type:"post",url:$.path+"/api/subscribeanalysis/findSubLoadFlow",params:r,contentType:"application/json",success:function(e){var e=e.data,t="",r="";$("#lineList").empty();for(var i in e){if(e[i]){var n=h(i,a);if(n.name!="订阅设备数"&&n.name!="订阅应用数"){r+="<option value='"+n.value+"'>"+n.name+"</option>"}var s=100/3+"%";var o=a==1?'style="padding:0"':"";t+='<div style="width:'+s+'">'+'<div class="col-md-2"'+o+'><i class="fa fa-upload"></i></div>'+'<div class="col-md-10">'+"<div>"+n.name+"</div>"+'<div class="num">'+e[i]+"</div>"+"</div>"+"</div>"}}$("#lineList").append(r);$(".counter").html(t)}})};var y=function(){$("#search").on("click",function(){var e=$(".ui-grid-buttonbar .ui-grid-linkGroup li.active").attr("key");a.search(n);p(e);f(e)})};var b=function(){var a=e.form.getParams($("#search-form"));if(!a.resourceId)a.resourceId="0";if(!a.equipment)a.equipment="0";var t=$.extend(a,{resType:1,model:1});var r="";for(var i in t){r+=i+"="+t[i]+"&"}var n=r.substring(0,r.length-1);window.location.href=$.path+"/api/commonController/downloadAnalysis?"+n};function T(){e.scroll({container:$(".scrollWrapper")})}var x=function(){$(".ui-grid-buttonbar .import").on("click",function(){b()});$("#search-form .sourceName").on("change",function(){var e=$(this).val();var a=$(".ui-grid-buttonbar .ui-grid-linkGroup li.active").attr("key")});$(".ui-grid-buttonbar .ui-grid-linkGroup li").on("click",function(){var e=$(this).attr("key");if(e=="1"){$("#fileContent").hide();$("#apiContent").hide();$("#dataContent").show()}else if(e=="2"){$("#dataContent").hide();$("#apiContent").hide();$("#fileContent").show()}else if(e=="3"){$("#dataContent").hide();$("#fileContent").hide();$("#apiContent").show()}v(e);g(e);p(e);f(e);d(e)});$("#lineList").on("change",function(){var e=$(".ui-grid-buttonbar .ui-grid-linkGroup li.active").attr("key");var a=$(this).val();var t=$(this).find("option:selected").text();p(e,t,a)})};return{main:function(){T();m();v();g();p();f();a.setPanelButtonbar();a.setGridLinkGroup();x();d();y()}}});