define(["base","app/commonApp","echarts","date"],function(e,a,t){var r=["#04a0fa","#fa7e04"];var i=["#fa4f04","#5edb02","#02d2b2","#6b03e1"];var n=null;var s={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,pagingType:"full_numbers",ajax:{url:$.path+"/api/publishanalysis/collectTable",type:"get",contentType:"application/json",data:function(t){a.gridPageFliter(t);var r=e.form.getParams($("#search-form"));if(!r.equipment)r.equipment="0";if(!r.resourceId)r.resourceId="0";var i;if(r){i=$.extend({resType:"1",page:t.page,size:t.size},r)}return i}},columns:[{data:"collectTime",sWidth:"12.5%"},{data:"pubResourceNum",sWidth:"12.5%"},{data:"subEquipmentNum",sWidth:"12.5%"},{data:"extractValue",sWidth:"12.5%"},{data:"loadValue",sWidth:"12.5%"},{data:"extractCount",sWidth:"12.5%"},{data:"loadCount",sWidth:"12.5%"},{data:"extractTaskNum",sWidth:"12.5%"}],drawCallback:function(e){}};var l={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,pagingType:"full_numbers",ajax:{url:$.path+"/api/publishanalysis/collectTable",type:"get",contentType:"application/json",data:function(t){a.gridPageFliter(t);var r=e.form.getParams($("#search-form"));if(!r.equipment)r.equipment="0";if(!r.resourceId)r.resourceId="0";var i;if(r){i=$.extend({resType:"2",page:t.page,size:t.size},r)}return i}},columns:[{data:"collectTime",sWidth:"16.6%"},{data:"pubResourceNum",sWidth:"16.6%"},{data:"subEquipmentNum",sWidth:"16.6%"},{data:"extractValue",sWidth:"16.6%"},{data:"loadValue",sWidth:"16.6%"},{data:"extractTaskNum",sWidth:"16.6%"}],drawCallback:function(e){}};var o={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,pagingType:"full_numbers",ajax:{url:$.path+"/api/publishanalysis/collectTable",type:"get",contentType:"application/json",data:function(t){a.gridPageFliter(t);var r=e.form.getParams($("#search-form"));if(!r.equipment)r.equipment="0";if(!r.resourceId)r.resourceId="0";var i;if(r){i=$.extend({resType:"3",page:t.page,size:t.size},r)}return i}},columns:[{data:"collectTime",sWidth:"25%"},{data:"pubResourceNum",sWidth:"25%"},{data:"subEquipmentNum",sWidth:"25%"},{data:"extractTaskNum",sWidth:"25%"}],drawCallback:function(e){}};var u=function(t){if(!t||t=="1"){n=e.datatables({container:$("#example1"),option:s,filter:a.gridFilter})}else if(t=="2"){n=e.datatables({container:$("#example2"),option:l,filter:a.gridFilter})}else if(t=="3"){n=e.datatables({container:$("#example3"),option:o,filter:a.gridFilter})}};var c={color:r,legend:{left:"center",data:[]},tooltip:{trigger:"axis",axisPointer:{animation:false}},xAxis:{type:"category",data:[],boundaryGap:true},yAxis:{type:"value",min:0,minInterval:1,boundaryGap:[0,0],splitLine:{show:true,lineStyle:{color:"#c0c0c0"}},axisLabel:{textStyle:{color:"#666"},formatter:function(e,a){return parseInt(e)}}},series:[{name:"流入",type:"line",hoverAnimation:false,smooth:true,areaStyle:{normal:{color:"#20a8d8",opacity:"0.2"}},data:[]}]};var d={color:["#2fb6e6","#faba3c","#67c2ef","#ff8e8e","#00acee"],tooltip:{trigger:"item",formatter:function(e){if(e.data.names.length>25){var a=[];for(var t=0;t<e.data.names.length;t++){if(t>=25&&t%25==0){a.push(e.data.names[t]+"<br />")}else{a.push(e.data.names[t])}}var r=a.join("");return e.seriesName+"<br />"+r+" ("+e.percent+"%)"}else{return e.seriesName+"<br />"+e.data.names+" ("+e.percent+"%)"}}},legend:{orient:"vertical",top:"middle",right:"18%",itemWidth:15,itemHeight:15,data:[]},series:[{name:"订阅设备",type:"pie",radius:["50%","70%"],avoidLabelOverlap:false,hoverAnimation:false,label:{normal:{show:true,position:"center",formatter:function(e,a,t,r){return e.seriesName}}},labelLine:{normal:{show:false}},center:["30%","50%"],data:[]}]};var p=function(a,r,i){var n={};n.chart=null;var s=e.form.getParams($("#search-form"));if(!s.equipment)s.equipment="0";if(!s.resourceId)s.resourceId="0";var l=$.extend({lineChartType:i?i:"1",resType:a?a:"1"},s);n.draw=function(i){e.ajax({url:$.path+"/api/publishanalysis/lineChartData",type:"post",params:l,success:function(i){var i=i.data;if(JSON.stringify(i)=="{}"){i=[{xvalue:"",yvalue:""}]}var s=[],l=[];i.forEach(function(e,a){s.push(e.xvalue);l.push(e.yvalue)});if(s.length==1){c.series[0].symbolSize=10}else{c.series[0].symbolSize=0}c.xAxis.data=s;c.series[0].data=l;var o;if(!a||a==1){o="发布资源数"}if(a==2){o="发布文件数"}if(a==3){o="发布API数"}c.series[0].name=r?r:o;n.chart=e.echarts({container:$("#chart1"),echarts:t,chartOption:c})}})};n.draw(true)};var m=function(a,r){var i={};i.chart=null;var n=e.form.getParams($("#search-form"));i.params={startTime:n.endTime,resType:a?a:"1"};i.draw=function(){e.ajax({url:$.path+"/api/publishanalysis/findExtractFlowEquipmentTop",type:"post",params:i.params,success:function(a){var a=a.data;if(JSON.stringify(a)=="{}"){a={"暂无订阅设备":0}}var r=[],n=[];for(var s in a){if(s&&s.indexOf("暂无")>-1){r.push(s);n.push({itemStyle:{normal:{color:"#d8d8d8"}},value:parseFloat(a[s]),name:s,names:s});d.color=["#d8d8d8"]}else{var l=s.slice(0,10);r.push(l);n.push({value:parseFloat(a[s]),name:l,names:s})}}d.legend.data=r;d.series[0].data=n;i.chart=e.echarts({container:$("#chart2"),chartOption:d,echarts:t})}})};i.draw()};var f=function(){e.form.date({element:$("#startTime"),dateOption:{max:laydate.now(-1,"YYYY-MM-DD")}});e.form.date({element:$("#endTime"),dateOption:{max:laydate.now()}});$("#startTime").val(laydate.now(-31,"YYYY-MM-DD"));$("#endTime").val(laydate.now(-1,"YYYY-MM-DD"))};var v=function(a){var t={resType:a?a:"1"};e.ajax({type:"post",url:$.path+"/api/publishanalysis/getResourceList",params:t,success:function(a){e.template({container:$(".sourceName"),templateId:"sourceName-tpl",data:a.data})}})};var h=function(a,t){var r={resType:a?a:"1",resourceId:t?t:"0"};e.ajax({type:"post",url:$.path+"/api/publishanalysis/getEquipmentList",params:r,success:function(a){e.template({container:$(".subDevice"),templateId:"subDevice-tpl",data:a.data})}})};var y=function(e,a){var t=[{key:"extractCount",label:"抽取记录数",type:"0",value:"3"},{key:"extractTaskNum",label:"任务执行次数",type:"0",value:"4"},{key:"extractValue",label:"抽取流量",type:"0",value:"2"},{key:"loadCount",label:"加载记录数",type:"0",value:"8"},{key:"loadValue",label:"加载流量",type:"0",value:"7"},{key:"pubResourceNum",label:"发布资源数",type:"0",value:"1"},{key:"subEquipmentNum",label:"订阅设备数",type:"0",value:""},{key:"appNum",label:"订阅应用数",type:"0",value:""}];if(e=="extractTaskNum"){if(a=="1")return{name:"任务执行次数",value:"4"};if(a=="2")return{name:"任务执行次数",value:"4"};if(a=="3")return{name:"调用次数",value:"6"}}if(e=="pubResourceNum"){if(a=="1")return{name:"发布资源数",value:"1"};if(a=="2")return{name:"发布文件数",value:"1"};if(a=="3")return{name:"发布API数",value:"1"}}for(var r=0;r<t.length;r++){if(t[r].key==e){return{name:t[r].label,value:t[r].value}}}};var g=function(a){var a=a?a:"1";var t=e.form.getParams($("#search-form"));if(!t.equipment)t.equipment="0";if(!t.resourceId)t.resourceId="0";var r=$.extend({resType:a},t);e.ajax({type:"post",url:$.path+"/api/publishanalysis/publishAnalysis",params:r,contentType:"application/json",success:function(e){var e=e.data,t="",r="";$("#lineList").empty();for(var i in e){if(e[i]){var n=y(i,a);if(n.name!="订阅设备数"&&n.name!="订阅应用数"){r+="<option value='"+n.value+"'>"+n.name+"</option>"}var s;if(a=="1")s=100/7+"%";if(a=="2")s=100/5+"%";if(a=="3")s=100/4+"%";var l=a==1?'style="padding:0"':"";t+='<div style="width:'+s+'">'+'<div class="col-md-2"'+l+'><i class="fa fa-upload"></i></div>'+'<div class="col-md-10">'+"<div>"+n.name+"</div>"+'<div class="num">'+e[i]+"</div>"+"</div>"+"</div>"}}$("#lineList").append(r);$(".counter").html(t)}})};var b=function(){$("#search").on("click",function(){var e=$(".ui-grid-buttonbar .ui-grid-linkGroup li.active").attr("key");a.search(n);p(e);m(e)})};var x=function(){var a=e.form.getParams($("#search-form"));if(!a.resourceId)a.resourceId="0";if(!a.equipment)a.equipment="0";var t=$.extend(a,{resType:1,model:2});var r="";for(var i in t){r+=i+"="+t[i]+"&"}var n=r.substring(0,r.length-1);window.location.href=$.path+"/api/commonController/downloadAnalysis?"+n};function T(){e.scroll({container:$(".scrollWrapper")})}var k=function(){$(".ui-grid-buttonbar .import").on("click",function(){x()});$("#search-form .sourceName").on("change",function(){var e=$(this).val();var a=$(".ui-grid-buttonbar .ui-grid-linkGroup li.active").attr("key");h(a,e)});$(".ui-grid-buttonbar .ui-grid-linkGroup li").on("click",function(){var e=$(this).attr("key");if(e=="1"){$("#fileContent").hide();$("#apiContent").hide();$("#dataContent").show()}else if(e=="2"){$("#dataContent").hide();$("#apiContent").hide();$("#fileContent").show()}else if(e=="3"){$("#dataContent").hide();$("#fileContent").hide();$("#apiContent").show()}v(e);h(e);g(e);p(e);m(e);u(e)});$("#lineList").on("change",function(){var e=$(".ui-grid-buttonbar .ui-grid-linkGroup li.active").attr("key");var a=$(this).val();var t=$(this).find("option:selected").text();p(e,t,a)})};return{main:function(){T();f();v();h();g();p();m();a.setPanelButtonbar();a.setGridLinkGroup();k();u();b()}}});